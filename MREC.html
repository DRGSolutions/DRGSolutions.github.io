<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRG SOLUTIONS - MR Cost Estimator</title>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    /* Reset & base */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; }
    body {
      display:flex; justify-content:center; align-items:center;
      background:linear-gradient(135deg,#74ABE2,#5563DE);
      color:#fff; padding:40px;
    }
    .container {
      width:100%; max-width:800px; text-align:center;
    }
    h1 { margin-bottom:20px; }
    .button, input[type=file] {
      display:inline-block;
      background:rgba(255,255,255,0.2);
      border:2px solid #fff;
      border-radius:50px;
      padding:15px 30px;
      font-size:1.1em;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:1px;
      transition:all .3s ease;
      cursor:pointer;
      margin:10px 5px;
      box-shadow:0 4px 15px rgba(0,0,0,0.2);
      text-decoration:none;
    }
    .button:hover, input[type=file]:hover {
      background:rgba(255,255,255,0.3);
      transform:translateY(-3px);
      box-shadow:0 6px 20px rgba(0,0,0,0.3);
    }
    #error {
      margin-top:20px;
      color:#ff6961;
      font-weight:bold;
    }
    #output {
      margin-top:20px;
      text-align:left;
      background:rgba(255,255,255,0.1);
      padding:20px;
      border-radius:10px;
      max-height:400px;
      overflow-y:auto;
      font-family:Consolas,monospace;
      font-size:.9em;
      line-height:1.4;
    }
    .mr-level {
      font-weight:bold;
      margin-top:10px;
      color:#FFD700;
    }
    hr { border-color:rgba(255,255,255,0.2); margin:15px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MR Cost Estimator</h1>
    <input type="file" id="csvFile" accept=".csv" /><br>
    <button id="processBtn" class="button">Calculate MR Cost</button>
    <div id="error"></div>
    <div id="output"></div>
  </div>

  <script>
  // ─── Constants & Keyword Arrays (identical to Python) ────────────────────────
  const DEFAULT_CLEARANCE_COST = 1000;
  const COMM_DROP_COST         = 500;
  const FULL_POWER_PRICING = {
    1:{no_equip:4000,equip:5000,guy:6700},
    2:{no_equip:5000,equip:6000,guy:7700},
    3:{no_equip:6800,equip:7800,guy:9500},
    4:{no_equip:8450,equip:9450,guy:13950}
  };
  const RISER_PRICING = {1:5000,3:10000};

  const COMM_KEYWORDS   = ['fiber','telecom','catv','communication'];
  const EQUIP_KEYWORDS  = ['transformer','arrestor'];
  const POWER_WIRE_KEY  = 'primary';
  const RISER_KEYWORD   = 'riser';

  // ─── Exact same regex as Python’s ADJUST_RE ────────────────────────────────
  const ADJUST_RE = /(.+?)\s+at\s+(\d+)'-(\d+)"\s*:\s*(Lower|Raise)\s+\d+"\s+to\s+(\d+)'-(\d+)"/ig;

  // ─── Parses only the Lower/Raise moves into [{desc,old,new},…] ─────────────
  function parseAdjustments(notes) {
    const moves = [];
    ADJUST_RE.lastIndex = 0;
    let m;
    while ((m = ADJUST_RE.exec(notes || '')) !== null) {
      moves.push({
        desc: m[1].trim(),
        old:  parseInt(m[2],10)*12 + parseInt(m[3],10),
        new:  parseInt(m[5],10)*12 + parseInt(m[6],10)
      });
    }
    return moves;
  }

  // ─── classifyScid ported 1 : 1 from your Python classify_scid ─────────────
  function classifyScid(notes, moves) {
    const real = moves.filter(m => !/proposed/i.test(m.desc));
    const nl   = (notes||'').toLowerCase();
    const replacement_flag = nl.includes('pole top:') && nl.includes('replace');
    const secondary_flag   = real.some(m => m.desc.toLowerCase().includes('secondary'));
    const lines = [];
    let power = 0, comm = 0;

    if (replacement_flag) {
      // count primary wires (exclude risers)
      const primary_count = real.filter(m=>
        m.desc.toLowerCase().includes(POWER_WIRE_KEY) &&
        !m.desc.toLowerCase().includes(RISER_KEYWORD)
      ).length;
      const phase = [1,2,3].includes(primary_count)?primary_count:4;

      const has_equip = real.some(m=>
        EQUIP_KEYWORDS.some(kw=>m.desc.toLowerCase().includes(kw))
      );
      const has_guy = real.some(m=>/down guy/i.test(m.desc));
      const cat = has_guy?'guy':has_equip?'equip':'no_equip';
      const p_cost = FULL_POWER_PRICING[phase][cat];
      power += p_cost;
      lines.push(`Pole replacement (phase ${phase}, ${cat.replace('_',' ')}): \$${p_cost.toLocaleString()}`);

      real.forEach(m => {
        const dl = m.desc.toLowerCase();
        if (dl.includes('com drop')) {
          comm += COMM_DROP_COST;
          lines.push(`Comm drop (${m.desc}): \$${COMM_DROP_COST.toLocaleString()}`);
        }
        else if (COMM_KEYWORDS.some(kw=>dl.includes(kw))) {
          comm += DEFAULT_CLEARANCE_COST;
          lines.push(`Comm cable move (${m.desc}): \$${DEFAULT_CLEARANCE_COST.toLocaleString()}`);
        }
      });

      real.forEach(m => {
        if (/down guy/i.test(m.desc)) {
          lines.push(`${m.desc}: no charge`);
        }
      });
    }
    else if (real.length && real.every(m=>m.desc.toLowerCase().includes(RISER_KEYWORD))) {
      const cnt = real.length;
      const phase = [1,3].includes(cnt)?cnt:1;
      const p_cost = RISER_PRICING[phase]||DEFAULT_CLEARANCE_COST;
      power += p_cost;
      lines.push(`${phase}-Phase Primary Riser only: \$${p_cost.toLocaleString()}`);
    }
    else {
      real.forEach(m => {
        const dl = m.desc.toLowerCase();
        if (dl.includes('drip loop') && secondary_flag && !replacement_flag) {
          lines.push(`${m.desc}: included in secondary move`);
        }
        else if (dl.includes('com drop')) {
          comm += COMM_DROP_COST;
          lines.push(`Comm drop (${m.desc}): \$${COMM_DROP_COST.toLocaleString()}`);
        }
        else if (COMM_KEYWORDS.some(kw=>dl.includes(kw))) {
          comm += DEFAULT_CLEARANCE_COST;
          lines.push(`Comm cable move (${m.desc}): \$${DEFAULT_CLEARANCE_COST.toLocaleString()}`);
        }
        else if (/down guy/i.test(dl)) {
          lines.push(`${m.desc}: no charge`);
        }
        else {
          power += DEFAULT_CLEARANCE_COST;
          lines.push(`${m.desc}: clearance = \$${DEFAULT_CLEARANCE_COST.toLocaleString()}`);
        }
      });
    }

    return { lines, power, comm, replacement_flag, secondary_flag };
  }

  // ─── UI wiring: handle Click, parse with PapaParse, display or error ─────
  document.getElementById('processBtn').addEventListener('click', ()=>{
    const errorDiv  = document.getElementById('error');
    const outputDiv = document.getElementById('output');
    errorDiv.textContent = '';
    outputDiv.innerHTML  = '';

    const fileInput = document.getElementById('csvFile');
    if (!fileInput.files.length) {
      return errorDiv.textContent = 'Error: Please select a CSV file.';
    }

    Papa.parse(fileInput.files[0], {
      header: true,
      skipEmptyLines: true,
      complete(results) {
        if (results.errors.length) {
          errorDiv.textContent = 'CSV Parse Error: ' + results.errors[0].message;
          return;
        }
        const rows = results.data;
        if (!rows.length) {
          return errorDiv.textContent = 'Error: No rows in CSV.';
        }
        // Validate columns
        const cols = Object.keys(rows[0]);
        if (!cols.includes('SCID') || !cols.includes('Make ready notes')) {
          return errorDiv.textContent = 'Error: CSV must include SCID and Make ready notes.';
        }

        let foundAny = false;
        rows.forEach(row => {
          const scid  = row['SCID'];
          const notes = row['Make ready notes'] || '';
          const moves = parseAdjustments(notes);
          if (!moves.length) return;

          foundAny = true;
          const { lines, power, comm, replacement_flag, secondary_flag } =
            classifyScid(notes, moves);
          const total = power + comm;

          outputDiv.innerHTML += `<div>SCID ${scid}:</div>`;
          lines.forEach(l => {
            outputDiv.innerHTML += `<div style="padding-left:20px;">${l}</div>`;
          });
          outputDiv.innerHTML += `
            <div style="padding-left:20px;">Power: \$${power.toLocaleString()}</div>
            <div style="padding-left:20px;">Comm:  \$${comm.toLocaleString()}</div>
            <div style="padding-left:20px;">Total: \$${total.toLocaleString()}</div>
          `;

          // MR LEVEL
          let level;
          if (total === 0) level = 'NO MR';
          else if (power === 0 && comm > 0) level = 'COMM MR';
          else if (replacement_flag) level = 'COMPLEX POWER MR';
          else if (power > 0 && comm === 0) {
            level = (power <= 2000 && !secondary_flag)
              ? 'SIMPLE POWER MR'
              : 'COMPLEX POWER MR';
          } else level = 'COMPLEX POWER MR';

          outputDiv.innerHTML += `<div class="mr-level">MR LEVEL: ${level}</div><hr>`;
        });

        if (!foundAny) {
          outputDiv.innerHTML = '<div>No raise/lower operations detected.</div>';
        }
      },
      error(err) {
        errorDiv.textContent = 'Error reading CSV: ' + err.message;
      }
    });
  });
  </script>
</body>
</html>
