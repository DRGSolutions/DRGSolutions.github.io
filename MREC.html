<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DRG SOLUTIONS - MR Cost Estimator</title>
  <style>
    /* ... your existing styles ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>MR Cost Estimator</h1>
    <input type="file" id="csvFile" accept=".csv" class="button"><br>
    <button id="processBtn" class="button">Calculate MR Cost</button>
    <div id="error"></div>
    <div id="output"></div>
  </div>

  <script>
    // --- Constants & Keywords (unchanged) ---
    const DEFAULT_CLEARANCE = 1000;
    const COMM_DROP         = 500;
    const FULL_POWER = { /* ... */ };
    const RISER_ONLY = {1:5000,3:10000};
    const COMM_KEYWORDS   = ['fiber','telecom','catv','communication'];
    const EQUIP_KEYWORDS  = ['transformer','arrestor'];
    const POWER_WIRE_KEY  = 'primary';
    const RISER_KEYWORD   = 'riser';

    // --- EXACT same regex as Python ADJUST_RE: requires Lower/Raise and "to" ---
    const ADJUST_RE = /(.+?)\s+at\s+(\d+)'-(\d+)"\s*:\s*(Lower|Raise)\s+\d+"\s+to\s+(\d+)'-(\d+)"/ig;

    function parseCSV(text) {
      const lines  = text.trim().split(/\r?\n/);
      const header = lines.shift().split(',');
      return lines.map(line => {
        const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
                        .map(s => s.replace(/^"|"$/g,''));
        const obj  = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        return obj;
      });
    }

    // ——— Now faithfully matching Python parse_adjustments() ———
    function parseAdjustments(notes) {
      const moves = [];
      ADJUST_RE.lastIndex = 0;
      let m;
      while ((m = ADJUST_RE.exec(notes || '')) !== null) {
        moves.push({
          desc: m[1].trim(),
          old:  parseInt(m[2],10)*12 + parseInt(m[3],10),
          new:  parseInt(m[5],10)*12 + parseInt(m[6],10)
        });
      }
      return moves;
    }

    // ——— classifyScid unchanged from before but using parseAdjustments() ———
    function classifyScid(notes, moves) {
      const real = moves.filter(m => !/proposed/i.test(m.desc));
      const nl   = (notes||'').toLowerCase();
      const replacement_flag = nl.includes('pole top:') && nl.includes('replace');
      const secondary_flag   = real.some(m => m.desc.toLowerCase().includes('secondary'));
      const lines = [];
      let power = 0, comm = 0;

      if (replacement_flag) {
        const primary_count = real.filter(m =>
          m.desc.toLowerCase().includes(POWER_WIRE_KEY) &&
          !m.desc.toLowerCase().includes(RISER_KEYWORD)
        ).length;
        const phase = [1,2,3].includes(primary_count) ? primary_count : 4;
        const has_equip = real.some(m =>
          EQUIP_KEYWORDS.some(kw => m.desc.toLowerCase().includes(kw))
        );
        const has_guy = real.some(m => /down guy/i.test(m.desc));
        const cat = has_guy ? 'guy' : has_equip ? 'equip' : 'no_equip';
        const p_cost = FULL_POWER[phase][cat];
        power += p_cost;
        lines.push(`Pole replacement (phase ${phase}, ${cat.replace('_',' ')}): \$${p_cost.toLocaleString()}`);
        real.forEach(m => {
          const dl = m.desc.toLowerCase();
          if (dl.includes('com drop')) {
            comm += COMM_DROP;
            lines.push(`Comm drop (${m.desc}): \$${COMM_DROP}`);
          } else if (COMM_KEYWORDS.some(kw => dl.includes(kw))) {
            comm += DEFAULT_CLEARANCE;
            lines.push(`Comm cable move (${m.desc}): \$${DEFAULT_CLEARANCE}`);
          }
        });
        real.forEach(m => {
          if (/down guy/i.test(m.desc)) {
            lines.push(`${m.desc}: no charge`);
          }
        });
      }
      else if (real.length && real.every(m => m.desc.toLowerCase().includes(RISER_KEYWORD))) {
        const cnt = real.length;
        const phase = [1,3].includes(cnt) ? cnt : 1;
        const p_cost = RISER_ONLY[phase] || DEFAULT_CLEARANCE;
        power += p_cost;
        lines.push(`${phase}-Phase Primary Riser only: \$${p_cost.toLocaleString()}`);
      }
      else {
        real.forEach(m => {
          const dl = m.desc.toLowerCase();
          if (dl.includes('drip loop') && secondary_flag && !replacement_flag) {
            lines.push(`${m.desc}: included in secondary move`);
          }
          else if (dl.includes('com drop')) {
            comm += COMM_DROP;
            lines.push(`Comm drop (${m.desc}): \$${COMM_DROP}`);
          }
          else if (COMM_KEYWORDS.some(kw => dl.includes(kw))) {
            comm += DEFAULT_CLEARANCE;
            lines.push(`Comm cable move (${m.desc}): \$${DEFAULT_CLEARANCE}`);
          }
          else if (/down guy/i.test(dl)) {
            lines.push(`${m.desc}: no charge`);
          }
          else {
            power += DEFAULT_CLEARANCE;
            lines.push(`${m.desc}: clearance = \$${DEFAULT_CLEARANCE}`);
          }
        });
      }

      return { lines, power, comm, replacement_flag, secondary_flag };
    }

    // ——— Wire up button exactly as before ———
    document.getElementById('processBtn').addEventListener('click', () => {
      const errorDiv  = document.getElementById('error');
      const outputDiv = document.getElementById('output');
      errorDiv.textContent = '';
      outputDiv.innerHTML  = '';

      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files[0]) {
        errorDiv.textContent = 'Error: Please select a CSV file.';
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const rows = parseCSV(e.target.result);
          if (!rows.length) throw new Error('No data found.');
          const cols = Object.keys(rows[0]);
          if (!cols.includes('SCID') || !cols.includes('Make ready notes')) {
            throw new Error('CSV must include SCID and Make ready notes.');
          }
          let found = false;
          rows.forEach(row => {
            const scid  = row['SCID'];
            const notes = row['Make ready notes'] || '';
            const moves = parseAdjustments(notes);
            if (!moves.length) return;
            found = true;
            const { lines, power, comm, replacement_flag, secondary_flag } =
                  classifyScid(notes, moves);
            const total = power + comm;

            outputDiv.innerHTML += `<div>SCID ${scid}:</div>`;
            lines.forEach(l =>
              outputDiv.innerHTML += `<div style="padding-left:20px;">${l}</div>`
            );
            outputDiv.innerHTML += `
              <div style="padding-left:20px;">Power: \$${power.toLocaleString()}</div>
              <div style="padding-left:20px;">Comm:  \$${comm.toLocaleString()}</div>
              <div style="padding-left:20px;">Total: \$${total.toLocaleString()}</div>
            `;
            let level;
            if (total === 0) level = 'NO MR';
            else if (power === 0 && comm > 0) level = 'COMM MR';
            else if (replacement_flag) level = 'COMPLEX POWER MR';
            else if (power > 0 && comm === 0) {
              level = (power <= 2000 && !secondary_flag)
                ? 'SIMPLE POWER MR' : 'COMPLEX POWER MR';
            } else level = 'COMPLEX POWER MR';
            outputDiv.innerHTML += `<div class="mr-level">MR LEVEL: ${level}</div><hr>`;
          });
          if (!found) {
            outputDiv.innerHTML = '<div>No raise/lower operations detected.</div>';
          }
        } catch (err) {
          errorDiv.textContent = 'Error: ' + err.message;
        }
      };
      reader.onerror = () => {
        errorDiv.textContent = 'Error reading file.';
      };
      reader.readAsText(fileInput.files[0]);
    });
  </script>
</body>
</html>
