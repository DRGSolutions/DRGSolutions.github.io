<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRG Solutions - Web Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;} 
    html,body{height:100%;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;}
    body{display:flex;flex-direction:column;justify-content:flex-start;align-items:center;background:linear-gradient(135deg,#74ABE2,#5563DE);color:#fff;padding:20px;}
    .container{width:100%;max-width:900px;text-align:center;display:flex;flex-direction:column;height:100%;}
    #map{flex:1 1 auto;height:100%;margin-top:20px;border:2px solid #fff;}
    .button,input[type=file]{display:inline-block;background:rgba(255,255,255,0.2);border:2px solid #fff;border-radius:50px;padding:10px 20px;font-size:1em;color:#fff;text-transform:uppercase;letter-spacing:1px;transition:all .3s ease;cursor:pointer;margin:5px;text-decoration:none;}
    .button:hover,input[type=file]:hover{background:rgba(255,255,255,0.3);transform:translateY(-3px);} 
  </style>
</head>
<body>
  <div class="container">
    <h1>Web Map Generator</h1>
    <div style="margin:10px;">
      <label><input type="radio" name="view" value="MR" checked> MR View</label>
      <label style="margin-left:20px;"><input type="radio" name="view" value="Utility"> Utility View</label>
    </div>
    <div style="margin:10px;">
      <input type="file" id="xlsxFile" accept=".xlsx,.xls" class="button" />
      <button id="genBtn" class="button">Generate Map</button>
      <button id="fullBtn" class="button" style="margin-left:10px;">Fullscreen</button>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
  <script>
    const STYLE_COLORS = {
      'No MR':            'green',
      'Comm MR':          'yellow',
      'Simple Power MR':  'orange',
      'Complex Power MR': 'red',
      'Deferred':         'gray',
      'Cannot Attach':    'black'
    };
    const MISSING_COLOR='purple';
    const WARNING_COLOR='aqua';
    const PALETTE=['blue','darkblue','teal','navy','magenta','lime'];
    const MULTI_COMP_COLOR='red';
    const MARKUP_COLORS=['red','orange','yellow','green','blue','purple','aqua','lime','black'];

    const DEFAULT_MARKUP = 'utilmarkupdata.geojson';
    let map, featureGroup, markupsHidden=false, labelsHidden=false;

    function firstVal(row, cols){
      for(let c of cols){
        const v=row[c];
        if(v!==undefined && v!==null && String(v).trim()) return String(v);
      }
      return '';
    }

    function canonCompany(v){
      v = String(v||'').trim();
      if(/magic valley elec coop|magic valley electric coop/i.test(v)) return 'Magic Valley Electric Coop';
      return v;
    }

    function convexHull(points){
      points = points.slice().sort((a,b)=>a[0]===b[0]?a[1]-b[1]:a[0]-b[0]);
      if(points.length<3) return points;
      function cross(o,a,b){return (a[0]-o[0])*(b[1]-o[1])-(a[1]-o[1])*(b[0]-o[0]);}
      const lower=[]; const upper=[];
      for(const p of points){
        while(lower.length>=2 && cross(lower[lower.length-2],lower[lower.length-1],p)<=0) lower.pop();
        lower.push(p);
      }
      for(let i=points.length-1;i>=0;i--){
        const p=points[i];
        while(upper.length>=2 && cross(upper[upper.length-2],upper[upper.length-1],p)<=0) upper.pop();
        upper.push(p);
      }
      upper.pop(); lower.pop();
      return lower.concat(upper);
    }

    function attachContext(layer){
      layer.on('contextmenu',()=>editLayer(layer));
      const p=layer.feature && layer.feature.properties;
      if(p){
        if(layer.setStyle){
          const col=p.color||layer.options.color||'blue';
          const op=p.opacity!=null?p.opacity:(layer.options.opacity!=null?layer.options.opacity:0.20);
          layer.setStyle({color:col,fillColor:col,opacity:op,fillOpacity:op});
        }
        if(p.label){
          const s=p.labelSize||10;
          const cls=p.isJobLabel?'job-label':'';
          layer.bindTooltip('<div style="font-size:'+s+'px">'+p.label+'</div>',{permanent:true,direction:'center',className:cls}).openTooltip();
        }
      }
    }

    function traverse(layer){
      if(layer.eachLayer){layer.eachLayer(traverse);} else {attachContext(layer);} }

    function editLayer(layer){
      const props = (layer.feature&&layer.feature.properties)||{};
      let col = props.color || layer.options.color || 'blue';
      let label = props.label || '';
      let size = props.labelSize || 10;
      let opacity = props.opacity!=null?props.opacity:(layer.options.opacity!=null?layer.options.opacity:0.20);
      const cInput = prompt('Color ('+MARKUP_COLORS.join(', ')+'):', col); if(cInput) col=cInput;
      const lInput = prompt('Label (optional):', label); if(lInput!==null) label=lInput;
      const sInput = prompt('Label size (px):', size); size=parseInt(sInput)||size;
      const oInput = prompt('Opacity % (0-100):', Math.round(opacity*100)); const o=parseFloat(oInput); if(!isNaN(o)) opacity=Math.max(0,Math.min(100,o))/100;
      if(layer.setStyle) layer.setStyle({color:col,fillColor:col,opacity:opacity,fillOpacity:opacity});
      if(label){
        const cls=props.isJobLabel?'job-label':'';
        layer.bindTooltip('<div style="font-size:'+size+'px">'+label+'</div>',{permanent:true,direction:'center',className:cls}).openTooltip();
      } else { layer.unbindTooltip(); }
      layer.feature = layer.feature||{type:'Feature',properties:{}};
      layer.feature.properties.color=col;
      layer.feature.properties.label=label;
      layer.feature.properties.labelSize=size;
      layer.feature.properties.opacity=opacity;
    }

    function toggleLabels(){
      const container = map.getContainer();
      if(labelsHidden){ container.classList.remove('hide-job-labels'); } else { container.classList.add('hide-job-labels'); }
      labelsHidden=!labelsHidden;
    }

    function toggleMarkups(){
      markupsHidden=!markupsHidden;
      featureGroup.eachLayer(layer=>{
        const props=(layer.feature&&layer.feature.properties)||{};
        if(props.isJobLabel) return; // always show job hulls
        if(markupsHidden) map.removeLayer(layer); else map.addLayer(layer);
      });
    }

    function addControls(){
      const css=document.createElement('style');
      css.textContent='.hide-job-labels .job-label{display:none;}#export{position:absolute;top:auto!important;bottom:10px;right:10px;left:auto!important;width:auto;height:auto;}';
      document.head.appendChild(css);
      const labelToggle=L.control({position:'topright'});
      labelToggle.onAdd=function(){
        const div=L.DomUtil.create('div','leaflet-bar leaflet-control');
        div.style.marginBottom='10px';
        const a=L.DomUtil.create('a','',div); a.href='#'; a.innerHTML='J'; a.title='Toggle Job Labels';
        L.DomEvent.on(a,'click',e=>{L.DomEvent.preventDefault(e);toggleLabels();});
        return div;};
      labelToggle.addTo(map);
      const markupToggle=L.control({position:'topright'});
      markupToggle.onAdd=function(){
        const div=L.DomUtil.create('div','leaflet-bar leaflet-control');
        div.style.marginBottom='10px';
        const a=L.DomUtil.create('a','',div); a.href='#'; a.innerHTML='M'; a.title='Toggle Markups';
        L.DomEvent.on(a,'click',e=>{L.DomEvent.preventDefault(e);toggleMarkups();});
        return div;};
      markupToggle.addTo(map);

      const exportCtrl=L.control({position:'bottomright'});
      exportCtrl.onAdd=function(){
        const a=L.DomUtil.create('a','leaflet-bar',null);
        a.id='export';
        a.href='#';
        a.innerHTML='Export';
        L.DomEvent.on(a,'click',e=>{
          L.DomEvent.preventDefault(e);
          const data=featureGroup.toGeoJSON();
          const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const link=document.createElement('a');
          link.href=url; link.download='markups.geojson';
          link.click();
          URL.revokeObjectURL(url);
        });
        return a;};
      exportCtrl.addTo(map);
    }

    async function generateMap(){
      const xfile=document.getElementById('xlsxFile').files[0];
      if(!xfile){alert('Select XLSX');return;}
      const view=document.querySelector('input[name=view]:checked').value;
      let markupData=null;
      if(view==='Utility'){
        try{
          const resp=await fetch(DEFAULT_MARKUP);
          if(resp.ok) markupData=await resp.json();
        }catch(err){console.warn('No default markup',err);}
      }
      const data=await parseXLSX(xfile);
      const rows=filterData(data,view);
      if(!rows.length){alert('No valid rows');return;}
      const columns=Object.keys(rows[0]);
      const levelCols=columns.filter(c=>c.toLowerCase().startsWith('mr_level'));
      const costCols=columns.filter(c=>c.toLowerCase().includes('mr_cost'));
      const warningCols=columns.filter(c=>c.toLowerCase().includes('warning'));
      const companyCols=columns.filter(c=>c.toLowerCase().includes('company'));
      buildLeafletMap(rows, {levelCols,costCols,warningCols,companyCols}, view, markupData);
    }

    function parseXLSX(file){
      return new Promise(res=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const workbook=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
          const sheet=workbook.Sheets[workbook.SheetNames[0]];
          const json=XLSX.utils.sheet_to_json(sheet,{defval:''});
          res(json);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function filterData(data,view){
      let rows=data.filter(r=>!/copy/i.test(String(r['job_name']||'')));
      rows=rows.filter(r=>String(r['node_type']||'').toLowerCase()==='pole');
      rows=rows.filter(r=>r['latitude']!=='' && r['longitude']!=='');
      rows=rows.filter(r=>/^\d+$/.test(String(r['scid']||'')));
      if(view==='Utility'){
        rows.forEach(r=>{r.base_job=String(r['job_name']||'').replace(/\s*\bPLA\b/i,'');});
        const plaJobs=new Set(rows.filter(r=>/\bPLA\b/i.test(r['job_name']||'')).map(r=>r.base_job));
        rows=rows.filter(r=>plaJobs.has(r.base_job)?/\bPLA\b/i.test(r['job_name']||''):true);
        rows.forEach(r=>{delete r.base_job;});
      } else {
        rows=rows.filter(r=>!/\bPLA\b/i.test(r['job_name']||''));
      }
      if(view==='Utility'){
        const compCols=Object.keys(rows[0]).filter(c=>/company/i.test(c));
        rows=rows.filter(r=>!compCols.some(c=>/\bAT&T\b|\bCharter\b/i.test(String(r[c]||''))));
      }
      return rows;
    }

    function buildLeafletMap(rows, cols, view, markupData){
      if(map){map.remove();}
      map=L.map('map',{maxZoom:19});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(map);
      const lats=rows.map(r=>parseFloat(r['latitude']));
      const lons=rows.map(r=>parseFloat(r['longitude']));
      const meanLat=lats.reduce((a,b)=>a+b,0)/lats.length;
      const meanLon=lons.reduce((a,b)=>a+b,0)/lons.length;
      map.setView([meanLat,meanLon],10);
      featureGroup=L.featureGroup().addTo(map);
      L.markerClusterGroup({disableClusteringAtZoom:7}).addTo(map);
      new L.Control.Draw({edit:{featureGroup:featureGroup}}).addTo(map);
      L.control.measure({position:'topleft'}).addTo(map);
      addControls();

      let compColor={};
      if(view==='Utility'){
        const comps=[];
        rows.forEach(r=>{
          cols.companyCols.forEach(c=>{const v=r[c]; if(v) comps.push(canonCompany(v));});
        });
        const uniq=[...new Set(comps)];
        compColor={'Magic Valley Electric Coop':'#98ff98','AEP':'orange','Brownsville Public Utilities':'aqua','Central Bradford PA':'yellow'};
        let idx=0;
        uniq.forEach(comp=>{if(!(comp in compColor)){compColor[comp]=PALETTE[idx%PALETTE.length];idx++;}});
      }

      rows.forEach(r=>{
        const lat=parseFloat(r['latitude']);
        const lon=parseFloat(r['longitude']);
        const scid=r['scid'];
        const warnings=cols.warningCols.map(c=>String(r[c]||'')).filter(v=>v.trim());
        const rawComps=cols.companyCols.map(c=>String(r[c]||'')).filter(v=>v.trim());
        const companies=(view==='MR')?(rawComps[0]? [rawComps[0]]:[]):rawComps.map(canonCompany);
        if(view==='MR'){
          const lvl=firstVal(r, cols.levelCols);
          const cost=firstVal(r, cols.costCols);
          let tooltip=`<b>SCID:</b> ${scid}<br><b>MR Level:</b> ${lvl||'<i>None</i>'}<br><b>Cost:</b> ${cost||'<i>None</i>'}`;
          if(warnings.length){
            tooltip+=`<br><b>Warnings:</b> ${warnings.join('; ')}`;
            L.circleMarker([lat,lon],{radius:6,color:WARNING_COLOR,fillColor:WARNING_COLOR,fillOpacity:0.9}).bindTooltip(tooltip).addTo(map);
          } else {
            const color=STYLE_COLORS[lvl]||MISSING_COLOR;
            L.circleMarker([lat,lon],{radius:6,fill:true,fillColor:color,fillOpacity:0.8,stroke:false}).bindTooltip(tooltip).addTo(map);
          }
        } else {
          let tooltip=`<b>SCID:</b> ${scid}<br><b>Companies:</b> ${companies.join(', ')||'<i>None</i>'}`;
          if(companies.length>1){
            L.circleMarker([lat,lon],{radius:6,color:MULTI_COMP_COLOR,fillColor:MULTI_COMP_COLOR,fillOpacity:0.9}).bindTooltip(tooltip).addTo(map);
          } else if(companies.length===1){
            const color=compColor[companies[0]]||PALETTE[0];
            L.circleMarker([lat,lon],{radius:6,fill:true,fillColor:color,fillOpacity:0.8,stroke:false}).bindTooltip(tooltip).addTo(map);
          } else {
            L.marker([lat,lon],{icon:L.divIcon({html:'<div style="color:red;font-size:16px;font-weight:bold;">X</div>',iconSize:[24,24],iconAnchor:[12,12]})}).bindTooltip(tooltip).addTo(map);
          }
        }
      });

      // Job hull polygons
      const jobs={};
      rows.forEach(r=>{ const job=r['job_name']; jobs[job]=jobs[job]||[]; jobs[job].push([parseFloat(r['longitude']),parseFloat(r['latitude'])]); });
      Object.entries(jobs).forEach(([job,pts])=>{
        if(pts.length<3) return;
        const hull=convexHull(pts); hull.push(hull[0]);
        const latlngs=hull.map(([x,y])=>[y,x]);
        const poly=L.polygon(latlngs,{color:'black',weight:2,opacity:0.20});
        poly.feature={type:'Feature',properties:{label:job,color:'black',labelSize:10,isJobLabel:true,opacity:0.20}};
        featureGroup.addLayer(poly);
        const cx=latlngs.reduce((a,b)=>a+b[1],0)/latlngs.length; // lon
        const cy=latlngs.reduce((a,b)=>a+b[0],0)/latlngs.length; // lat
        const m=L.marker([cy,cx],{icon:L.divIcon({html:'<div style="font-size:10px;font-weight:bold;">'+job+'</div>',className:'job-label'})});
        m.feature={type:'Feature',properties:{isJobLabel:true,label:job,labelSize:10}};
        featureGroup.addLayer(m);
      });

      function addMarkup(data){
        const gj=L.geoJSON(data,{style:f=>({color:f.properties.color||'blue',fillColor:f.properties.color||'blue',opacity:f.properties.opacity||0.20,fillOpacity:f.properties.opacity||0.20})});
        gj.eachLayer(l=>{featureGroup.addLayer(l);});
      }
      if(markupData){
        addMarkup(markupData);
      }

      map.fitBounds(L.latLngBounds(lats.map((lat,i)=>[lat,lons[i]])));

      map.on(L.Draw.Event.CREATED,e=>{const layer=e.layer; editLayer(layer); featureGroup.addLayer(layer);});
      featureGroup.eachLayer(traverse);
    }

    document.getElementById('genBtn').addEventListener('click', generateMap);
    document.getElementById('fullBtn').addEventListener('click', () => {
      const elem=document.documentElement;
      if(elem.requestFullscreen){ elem.requestFullscreen(); }
    });
  </script>
</body>
</html>